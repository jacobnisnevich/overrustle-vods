<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<title>OverRustle VODs</title>

	<link rel="icon" type="image/png" href="./favicon.png" />

	<link rel="stylesheet" href="octicons/octicons.css">
	<link rel="stylesheet" href="css/tooltipster.bundle.min.css" />
	<link rel="stylesheet" href="css/styles.css"/>
	<link rel="stylesheet" href="css/bbdgg.css"/>

	<link href='https://fonts.googleapis.com/css?family=Ubuntu' rel='stylesheet' type='text/css'>
	<link href="https://fonts.googleapis.com/css?family=Ubuntu+Mono" rel="stylesheet">

	<script src= "https://player.twitch.tv/js/embed/v1.js"></script>
	<script async defer src="https://buttons.github.io/buttons.js"></script>
	<script src="https://unpkg.com/split.js/dist/split.min.js"></script>
	<script src="js/lib/moment.min.js"></script>
	<script src="js/lib/jquery-2.1.4.min.js"></script>
	<script src="js/lib/tooltipster.bundle.min.js"></script>
	<script src="js/lib/jquery.tmpl.min.js"></script>

	<script src="js/bbdgg.js"></script>
	<script src="js/util.js"></script>
	<script src="js/chat.js"></script>
	<script src="js/scripts.js"></script>

	<base target="_blank">
</head>
<body>
	<script id="vod-tmpl" type="text/x-jquery-tmpl">
		<div id="${id}" class="vod-entry shadow">
			<div class="image-container">
				<img src="${image}"/>
				<div class="overlay-container">
					<div class="views"><span class="octicon octicon-eye"></span>&nbsp;${views}</div>
					<div class="length"><span class="octicon octicon-watch"></span>&nbsp;${length}</div>
				</div>
				<div class="game-overlay">${game}</div>
			</div>
			<div class="info-container">
				<div class="title">${title}</div>
				<div class="date">${date}</div>
			</div>
		</div>
	</script>

	<script>
		// adding a random number to the emote stylesheet url so that we avoid caching and (hopefully) always get the most recent version
		// from https://stackoverflow.com/questions/58972512/linking-a-css-file-with-version-number-for-cache-busting
		window.addEventListener('load', function() {
  			var head = document.querySelector('head');
  			head.innerHTML += '<link rel="stylesheet" href="https://cdn.destiny.gg/emotes/emotes.css?_=' + Math.random() + '" type="text/css">';
		});
	</script>

	<script>
		// detecting if url is yt or twitch
		function vodURL(url) {
			var urlCheck = /^((http[s]?|ftp):\/)?\/?([^:\/\s]+)((\/\w+)*\/)([\w\-\.]+[^#?\s]+)(.*)?(#[\w\-]+)?$/gm;
			var matches = url.matchAll(urlCheck);
			var matchArray = [...matches];
			if (matchArray[0][3] === "www.twitch.tv" || matchArray[0][3] === "twitch.tv") {
				regex = new RegExp('(?=[0-9])[^\/]+', 'gm');
				replaced = url.match(regex);
				window.location.href = window.location.origin + "?id=" + replaced[0].replace(/[?]/gm, '&');
			}
			if (matchArray[0][3] === "www.youtube.com" || matchArray[0][3] === "www.youtube.com") {
				window.location.href = window.location.origin + matchArray[0][7];
			}
			if (matchArray[0][3] === "youtu.be") {
				window.location.href = window.location.origin + "?v=" + matchArray[0][6] + matchArray[0][7].replace(/[?]/gm, '&');
			}
		};
	</script>

	<script>
		// click button on "Enter" press
		// stolen from https://stackoverflow.com/questions/155188/trigger-a-button-click-with-javascript-on-the-enter-key-in-a-text-box
		window.onload = function () {
			document.getElementById("customUrlText").addEventListener("keyup", function(event) {
				event.preventDefault();
				if (event.keyCode === 13) {
					document.getElementById("customUrlButton").click();
				};
			});
		};
	</script>

	<div id="header" class="shadow">
		<div id="header-title">OverRustle VODs</div>
		<div id="header-links">
			<div id="changelog-button"><a>Changelog</a></div>
			<div><input type="text" id="customUrlText" name="vodurl" placeholder="Twitch/Youtube link"></div>
			<div><input id="customUrlButton" value="Submit" onclick="vodURL(document.getElementById('customUrlText').value)" type="button"></div>
			<div><a href="https://www.destiny.gg">Destiny.gg</a></div>
			<div><a id="destiny-status" href="https://www.destiny.gg/bigscreen">Destiny is offline.</a></div>
			<div><a class="github-button" href="https://github.com/jacobnisnevich/overrustle-vods" data-icon="octicon-repo-forked" aria-label="Fork overrustle-vods on GitHub">Fork</a></div>
		</div>
	</div>

	<div id="body">
		<div id="changelog" class="view">
			<div id="close-changelog-button"><span class="octicon octicon-x"></span></div>
			<div id="changelog-text">
				2020-05-24: <br>
				1. playback speed up to 2x should be synced with chat now (decreased setinterval delay, hopefully this doesn't cause any problems) <br>
				2020-05-22: <br>
				1. added the ability to watch youtube vods with chat (only works with stream recordings, regular videos won't work) <br>
				2. added a loading screen for chat
			</div>
		</div>
		<div id="browse" class="view container">
			<div id="page-selector">
				<div id="previous-page-button" class="disabled"><span class="octicon octicon-arrow-left"></span></div>
				<div id="page-number-container">Page <span id="page-number">1</span></div>
				<div id="next-page-button"><span class="octicon octicon-arrow-right"></span></div>
			</div>
			<div id="vod-list"></div>
		</div>
		<div id="player" class="view" style="flex-direction: row;">
			<div id="video-player"></div>
			<div id="chat-container">
				<div id="chat-controls">
					<div id="delay-controls">
						<div id="dec-delay-button"><span class="octicon octicon-arrow-left"></span></div>
						<div id="delay-container">Delay: <span id="delay">2</span> sec.</div>
						<div id="inc-delay-button"><span class="octicon octicon-arrow-right"></span></div>
					</div>
					<div id="switch-sides-button"><span class="octicon octicon-mirror"></span></div>
				</div>
				<div id="chat-stream"></div>
			</div>
		</div>
	</div>

	<div id="footer"></div>
</body>
</html>
